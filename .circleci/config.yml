version: 2.1
jobs:
  build:
    docker:
      - image: condaforge/mambaforge:latest
    steps:
      - checkout
      - run:
          name: Install essential build tools
          command: |
            apt-get update
            apt-get install -y build-essential
      - run:
          name: Install dependencies
          command: |
            mamba env create -f environment.yaml
            source activate absplice
            pip install -e .
      - run:
          name: Run tests
          command: |
            source activate absplice
            pytest tests/
      - run:
          name: Run example without lookup
          command: |
            source activate absplice
            cd example
            python -m snakemake -j 1 --use-conda
      - run:
          name: Run example with lookup
          command: |
            source activate absplice
            cd example
            python -m snakemake -j 1 --use-conda --config use_rocksdb=True
workflows:
  version: 2
  build-and-test:
    jobs:
      - build
